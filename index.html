<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v2.0 - RPG AR Experience - Image Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #ffffff;
            color: #333;
            overflow: hidden;
        }

        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .container {
            text-align: center;
            max-width: 500px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #2c2c2c;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 40px;
        }

        .artwork-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 40px 30px;
            margin-bottom: 20px;
        }

        .artwork-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #2c2c2c;
        }

        .artwork-description {
            color: #666;
            margin-bottom: 25px;
        }

        #start-button {
            background: #2c2c2c;
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
        }

        #start-button:hover {
            background: #1a1a1a;
        }

        #ar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            background: black;
        }

        #video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #ar-content {
            position: absolute;
            display: none;
        }

        #ar-video {
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        #status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
        }

        #debug-info {
            position: absolute;
            top: 70px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 5px;
            min-width: 300px;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
        }

        button {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            margin: 5px;
            display: block;
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <div class="container">
            <h1>RPG AR Experience</h1>
            <p class="subtitle">Advanced Image Detection - v2.0</p>
            
            <div class="artwork-card">
                <h2 class="artwork-title">The Adoration of the Shepherds, Guido Reni</h2>
                <p class="artwork-description">Point your camera at the painting to begin the AR experience</p>
                <button id="start-button">Start Experience</button>
            </div>
        </div>
    </div>

    <div id="ar-container">
        <video id="video-feed" autoplay playsinline muted></video>
        
        <div id="ar-content">
            <video id="ar-video" loop muted playsinline preload="auto">
                <source src="vid1.mp4" type="video/mp4">
            </video>
        </div>

        <div id="status">Initializing...</div>
        
        <div id="debug-info">
            <div>Confidence: <span id="confidence">0%</span></div>
            <div>Position: <span id="position">-,-</span></div>
            <div>FPS: <span id="fps">-</span></div>
            <div>Template: <span id="template-status">Loading...</span></div>
        </div>

        <div id="controls">
            <button id="test-button">Test Detection</button>
            <button id="debug-button">Debug Template</button>
        </div>
    </div>

    <script>
        class SimpleARTracker {
            constructor() {
                // Core elements
                this.video = null;
                this.canvas = null;
                this.ctx = null;
                this.arVideo = null;
                this.arContent = null;
                
                // Detection state
                this.isTracking = false;
                this.targetImage = null;
                this.templateWidth = 0;
                this.templateHeight = 0;
                
                // Settings - simplified for reliability
                this.confidenceThreshold = 0.40; // Reasonable threshold
                this.requiredFrames = 2; // Less strict requirement
                this.consecutiveDetections = 0;
                
                // Performance
                this.frameCount = 0;
                this.lastFpsTime = Date.now();
                
                this.init();
            }

            init() {
                document.getElementById('start-button').addEventListener('click', () => {
                    this.startAR();
                });
                
                document.getElementById('test-button').addEventListener('click', () => {
                    this.testDetection();
                });
                
                document.getElementById('debug-button').addEventListener('click', () => {
                    this.debugTemplate();
                });
                
                this.arContent = document.getElementById('ar-content');
                this.arVideo = document.getElementById('ar-video');
            }

            async startAR() {
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('ar-container').style.display = 'block';

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });

                    this.video = document.getElementById('video-feed');
                    this.video.srcObject = stream;
                    
                    // Create processing canvas
                    this.canvas = document.createElement('canvas');
                    this.ctx = this.canvas.getContext('2d');

                    this.video.onloadedmetadata = () => {
                        console.log(`Video dimensions: ${this.video.videoWidth}x${this.video.videoHeight}`);
                        
                        // Set canvas to reasonable processing size
                        this.canvas.width = 320;
                        this.canvas.height = 240;
                        
                        this.loadTargetImage();
                    };

                } catch (error) {
                    this.updateStatus('Camera access denied');
                    console.error('Camera error:', error);
                }
            }

            loadTargetImage() {
                this.updateStatus('Loading target image...');
                console.log('Loading paint1.jpg...');
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    console.log(`Target image loaded: ${img.width}x${img.height}`);
                    
                    // Create template - keep it simple
                    const targetCanvas = document.createElement('canvas');
                    const targetCtx = targetCanvas.getContext('2d');
                    
                    // Fixed template size for simplicity
                    targetCanvas.width = 80;
                    targetCanvas.height = 107; // Matches paint1.jpg aspect ratio
                    targetCtx.drawImage(img, 0, 0, 80, 107);
                    
                    this.targetImage = targetCtx.getImageData(0, 0, 80, 107);
                    this.templateWidth = 80;
                    this.templateHeight = 107;
                    
                    document.getElementById('template-status').textContent = `${this.templateWidth}x${this.templateHeight}`;
                    
                    console.log('Template ready, starting detection...');
                    this.updateStatus('Point camera at painting');
                    this.startTracking();
                };
                
                img.onerror = () => {
                    console.error('Failed to load paint1.jpg');
                    this.updateStatus('Failed to load target image');
                    document.getElementById('template-status').textContent = 'Failed';
                };
                
                img.src = 'paint1.jpg';
            }

            startTracking() {
                this.isTracking = true;
                this.trackingLoop();
            }

            trackingLoop() {
                if (!this.isTracking) return;

                try {
                    // Capture video frame
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    const frameData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Simple template matching
                    const detection = this.detectImage(frameData);
                    
                    // Update debug display
                    document.getElementById('confidence').textContent = Math.round(detection.confidence * 100) + '%';
                    document.getElementById('position').textContent = `${Math.round(detection.x)},${Math.round(detection.y)}`;
                    
                    if (detection.confidence > this.confidenceThreshold) {
                        this.consecutiveDetections++;
                        console.log(`Detection ${this.consecutiveDetections}/${this.requiredFrames}: ${Math.round(detection.confidence * 100)}%`);
                        
                        if (this.consecutiveDetections >= this.requiredFrames) {
                            this.onImageDetected(detection);
                        }
                    } else {
                        this.consecutiveDetections = 0;
                        this.onImageLost();
                    }
                    
                    this.updateFPS();
                    
                } catch (error) {
                    console.error('Tracking error:', error);
                }

                requestAnimationFrame(() => this.trackingLoop());
            }

            detectImage(frameData) {
                let bestMatch = { confidence: 0, x: 0, y: 0 };
                
                // Test multiple scales
                const scales = [0.8, 1.0, 1.2];
                
                for (const scale of scales) {
                    const match = this.templateMatch(frameData, scale);
                    if (match.confidence > bestMatch.confidence) {
                        bestMatch = match;
                    }
                }
                
                return bestMatch;
            }

            templateMatch(frameData, scale) {
                const templateW = Math.floor(this.templateWidth * scale);
                const templateH = Math.floor(this.templateHeight * scale);
                const step = 8; // Skip pixels for speed
                
                let bestScore = 0;
                let bestX = 0;
                let bestY = 0;
                
                // Search across the frame
                for (let y = 0; y <= frameData.height - templateH; y += step) {
                    for (let x = 0; x <= frameData.width - templateW; x += step) {
                        const score = this.calculateMatch(frameData, x, y, templateW, templateH);
                        if (score > bestScore) {
                            bestScore = score;
                            bestX = x;
                            bestY = y;
                        }
                    }
                }
                
                return {
                    confidence: bestScore,
                    x: bestX,
                    y: bestY,
                    width: templateW,
                    height: templateH
                };
            }

            calculateMatch(frameData, startX, startY, width, height) {
                let score = 0;
                let samples = 0;
                const step = 2;
                
                for (let y = 0; y < height; y += step) {
                    for (let x = 0; x < width; x += step) {
                        const frameX = startX + x;
                        const frameY = startY + y;
                        
                        if (frameX < frameData.width && frameY < frameData.height) {
                            const frameIdx = (frameY * frameData.width + frameX) * 4;
                            
                            // Map to template coordinates
                            const templateX = Math.floor((x / width) * this.templateWidth);
                            const templateY = Math.floor((y / height) * this.templateHeight);
                            const templateIdx = (templateY * this.templateWidth + templateX) * 4;
                            
                            if (templateIdx < this.targetImage.data.length) {
                                // Simple RGB difference
                                const frameR = frameData.data[frameIdx];
                                const frameG = frameData.data[frameIdx + 1];
                                const frameB = frameData.data[frameIdx + 2];
                                const templateR = this.targetImage.data[templateIdx];
                                const templateG = this.targetImage.data[templateIdx + 1];
                                const templateB = this.targetImage.data[templateIdx + 2];
                                
                                const diff = Math.abs(frameR - templateR) + 
                                           Math.abs(frameG - templateG) + 
                                           Math.abs(frameB - templateB);
                                
                                const pixelScore = Math.max(0, (765 - diff) / 765); // 765 = 255*3
                                score += pixelScore;
                                samples++;
                            }
                        }
                    }
                }
                
                return samples > 0 ? score / samples : 0;
            }

            onImageDetected(detection) {
                this.updateStatus('ðŸŽ¯ Image detected! Playing AR content');
                
                // Position AR content
                const videoRect = this.video.getBoundingClientRect();
                const scaleX = videoRect.width / this.canvas.width;
                const scaleY = videoRect.height / this.canvas.height;
                
                const x = detection.x * scaleX;
                const y = detection.y * scaleY;
                const w = detection.width * scaleX;
                const h = detection.height * scaleY;
                
                this.arContent.style.left = x + 'px';
                this.arContent.style.top = y + 'px';
                this.arContent.style.display = 'block';
                
                this.arVideo.style.width = Math.max(200, w) + 'px';
                this.arVideo.style.height = Math.max(150, h) + 'px';
                
                if (this.arVideo.paused) {
                    this.arVideo.play().catch(e => console.log('Video play failed:', e));
                }
            }

            onImageLost() {
                this.updateStatus('Searching for painting...');
                this.arContent.style.display = 'none';
                if (!this.arVideo.paused) {
                    this.arVideo.pause();
                }
            }

            testDetection() {
                const mockDetection = {
                    confidence: 0.8,
                    x: this.canvas.width / 2 - 40,
                    y: this.canvas.height / 2 - 30,
                    width: 80,
                    height: 107
                };
                
                console.log('Testing AR overlay positioning...');
                this.onImageDetected(mockDetection);
                
                setTimeout(() => {
                    this.onImageLost();
                }, 5000);
            }

            debugTemplate() {
                console.log('=== TEMPLATE DEBUG ===');
                console.log(`Template loaded: ${!!this.targetImage}`);
                console.log(`Dimensions: ${this.templateWidth}x${this.templateHeight}`);
                
                if (this.targetImage) {
                    console.log(`Data length: ${this.targetImage.data.length}`);
                    
                    // Show first few pixels
                    const samples = [];
                    for (let i = 0; i < Math.min(20, this.targetImage.data.length); i += 4) {
                        samples.push(`[${this.targetImage.data[i]},${this.targetImage.data[i+1]},${this.targetImage.data[i+2]}]`);
                    }
                    console.log(`First 5 pixels: ${samples.join(', ')}`);
                }
                console.log('=== END DEBUG ===');
            }

            updateStatus(message) {
                document.getElementById('status').textContent = message;
                console.log('Status:', message);
            }

            updateFPS() {
                this.frameCount++;
                const now = Date.now();
                if (now - this.lastFpsTime >= 1000) {
                    const fps = Math.round(this.frameCount * 1000 / (now - this.lastFpsTime));
                    document.getElementById('fps').textContent = fps;
                    this.frameCount = 0;
                    this.lastFpsTime = now;
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SimpleARTracker();
        });
    </script>
</body>
</html>