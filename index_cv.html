<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG AR Experience - Computer Vision</title>
    <script src="https://docs.opencv.org/4.x/opencv.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #start-button {
            background: #ff6b6b;
            border: none;
            color: white;
            padding: 20px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            max-width: 90%;
            word-wrap: break-word;
        }

        #start-button:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        #camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
        }

        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #debug-canvas {
            position: absolute;
            top: 10px;
            left: 10px;
            border: 1px solid #fff;
            max-width: 200px;
            max-height: 150px;
        }

        #ar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #ar-video {
            position: absolute;
            display: none;
            max-width: 300px;
            max-height: 200px;
            border: 2px solid #00ff00;
            border-radius: 10px;
        }

        #status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            color: #fff;
        }

        #template-img {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            border: 1px solid #fff;
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <h1>RPG AR Experience</h1>
        <p>Advanced computer vision image tracking</p>
        <p>Point your camera at "The Adoration of the Shepherds" painting to reveal hidden content</p>
        <button id="start-button">The Adoration of the Shepherds, Guido Reni</button>
    </div>

    <div id="camera-container">
        <video id="camera-feed" autoplay playsinline></video>
        <canvas id="debug-canvas"></canvas>
        <div id="ar-overlay">
            <video id="ar-video" loop muted playsinline>
                <source src="vid1.mp4" type="video/mp4">
            </video>
        </div>
        <div id="status">Initializing...</div>
        <img id="template-img" src="paint1.jpg" alt="Target">
    </div>

    <script>
        class ComputerVisionAR {
            constructor() {
                this.isRunning = false;
                this.template = null;
                this.templateFeatures = null;
                this.video = null;
                this.canvas = null;
                this.ctx = null;
                this.arVideo = null;
                this.lastDetection = 0;
                this.detectionThreshold = 0.7;
                
                this.init();
            }

            init() {
                document.getElementById('start-button').addEventListener('click', () => {
                    this.startAR();
                });
            }

            async startAR() {
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('camera-container').style.display = 'block';
                
                try {
                    // Initialize camera
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });

                    this.video = document.getElementById('camera-feed');
                    this.video.srcObject = stream;
                    
                    this.canvas = document.getElementById('debug-canvas');
                    this.ctx = this.canvas.getContext('2d');
                    this.arVideo = document.getElementById('ar-video');

                    // Wait for video to load
                    this.video.onloadedmetadata = () => {
                        this.canvas.width = this.video.videoWidth / 4; // Smaller for performance
                        this.canvas.height = this.video.videoHeight / 4;
                        this.loadTemplate();
                    };

                } catch (error) {
                    console.error('Camera access failed:', error);
                    document.getElementById('status').textContent = 'Camera access denied';
                }
            }

            async loadTemplate() {
                document.getElementById('status').textContent = 'Loading template...';
                
                try {
                    // Load template image
                    const templateImg = new Image();
                    templateImg.crossOrigin = 'anonymous';
                    templateImg.onload = () => {
                        // Create template canvas
                        const templateCanvas = document.createElement('canvas');
                        const templateCtx = templateCanvas.getContext('2d');
                        templateCanvas.width = 200; // Standard size
                        templateCanvas.height = 200;
                        
                        // Draw and resize template
                        templateCtx.drawImage(templateImg, 0, 0, 200, 200);
                        this.template = templateCtx.getImageData(0, 0, 200, 200);
                        
                        document.getElementById('status').textContent = 'Template loaded. Searching...';
                        this.startTracking();
                    };
                    templateImg.src = 'paint1.jpg';
                    
                } catch (error) {
                    console.error('Template loading failed:', error);
                    document.getElementById('status').textContent = 'Failed to load template';
                }
            }

            startTracking() {
                this.isRunning = true;
                this.trackingLoop();
            }

            trackingLoop() {
                if (!this.isRunning) return;

                try {
                    // Draw video frame to canvas for analysis
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    
                    // Get current frame
                    const frameData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Simple template matching
                    const match = this.templateMatch(frameData);
                    
                    if (match.confidence > this.detectionThreshold) {
                        this.onImageDetected(match);
                        this.lastDetection = Date.now();
                    } else if (Date.now() - this.lastDetection > 1000) {
                        this.onImageLost();
                    }

                } catch (error) {
                    console.error('Tracking error:', error);
                }

                // Continue tracking
                requestAnimationFrame(() => this.trackingLoop());
            }

            templateMatch(frameData) {
                // Simplified template matching
                // In production, use OpenCV.js matchTemplate function
                
                let bestScore = 0;
                let bestX = 0;
                let bestY = 0;
                
                const stepSize = 10; // Skip pixels for performance
                const templateWidth = 200;
                const templateHeight = 200;
                
                // Scan frame for template matches
                for (let y = 0; y < frameData.height - templateHeight; y += stepSize) {
                    for (let x = 0; x < frameData.width - templateWidth; x += stepSize) {
                        const score = this.calculateSimilarity(frameData, x, y);
                        if (score > bestScore) {
                            bestScore = score;
                            bestX = x;
                            bestY = y;
                        }
                    }
                }

                return {
                    confidence: bestScore,
                    x: bestX,
                    y: bestY,
                    width: templateWidth,
                    height: templateHeight
                };
            }

            calculateSimilarity(frameData, startX, startY) {
                // Simple normalized cross correlation
                let correlation = 0;
                let frameVariance = 0;
                let templateVariance = 0;
                
                const sampleSize = 100; // Sample points for performance
                
                for (let i = 0; i < sampleSize; i++) {
                    const x = Math.floor(Math.random() * 200);
                    const y = Math.floor(Math.random() * 200);
                    
                    if (startX + x < frameData.width && startY + y < frameData.height) {
                        const frameIdx = ((startY + y) * frameData.width + (startX + x)) * 4;
                        const templateIdx = (y * 200 + x) * 4;
                        
                        if (frameIdx < frameData.data.length && templateIdx < this.template.data.length) {
                            // Convert to grayscale
                            const frameGray = (frameData.data[frameIdx] + frameData.data[frameIdx + 1] + frameData.data[frameIdx + 2]) / 3;
                            const templateGray = (this.template.data[templateIdx] + this.template.data[templateIdx + 1] + this.template.data[templateIdx + 2]) / 3;
                            
                            correlation += frameGray * templateGray;
                            frameVariance += frameGray * frameGray;
                            templateVariance += templateGray * templateGray;
                        }
                    }
                }
                
                // Normalized correlation coefficient
                const denominator = Math.sqrt(frameVariance * templateVariance);
                return denominator > 0 ? correlation / denominator / sampleSize : 0;
            }

            onImageDetected(match) {
                document.getElementById('status').textContent = `Image detected! (${Math.round(match.confidence * 100)}%)`;
                document.getElementById('status').style.color = '#00ff00';
                
                // Position and show AR video
                const scaleX = window.innerWidth / this.canvas.width;
                const scaleY = window.innerHeight / this.canvas.height;
                
                const arVideo = this.arVideo;
                arVideo.style.display = 'block';
                arVideo.style.left = (match.x * scaleX) + 'px';
                arVideo.style.top = (match.y * scaleY) + 'px';
                
                // Play video
                if (arVideo.paused) {
                    arVideo.play().catch(e => console.log('Video play failed:', e));
                }
            }

            onImageLost() {
                document.getElementById('status').textContent = 'Searching for image...';
                document.getElementById('status').style.color = '#ffffff';
                
                // Hide AR video
                this.arVideo.style.display = 'none';
                if (!this.arVideo.paused) {
                    this.arVideo.pause();
                }
            }
        }

        // Wait for OpenCV to load
        function onOpenCvReady() {
            console.log('OpenCV.js is ready');
            new ComputerVisionAR();
        }

        // Fallback if OpenCV doesn't load
        setTimeout(() => {
            if (typeof cv === 'undefined') {
                console.log('OpenCV not loaded, using fallback');
                new ComputerVisionAR();
            }
        }, 5000);
    </script>
</body>
</html>